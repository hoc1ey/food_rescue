<app-toast-container></app-toast-container>

<app-header 
  title="Dashboard de Donante" 
  subtitle="KFC Calle Mayor"
  theme="donor"
  (logoutClick)="handleLogout()">
</app-header>

<main class="dashboard-content">
  <!-- Tarjeta de Horario -->
  <app-card-schedule 
    [scheduleData]="scheduleData" 
    [theme]="'donor'">
  </app-card-schedule>

  <div class="new-donation-action">
    <app-button (click)="onNewDonation()" theme="donor">
      <lucide-icon name="plus" class="button-icon"></lucide-icon>
      Publicar Nueva Donación
    </app-button>
  </div>

  <!-- Tarjeta de Donaciones Publicadas -->
  <div class="card">
    <div class="card-header-with-count">
      <app-card-header 
        title="Mis Donaciones Publicadas" 
        icon="package" 
        theme="donor">
      </app-card-header>
      <span class="donation-count">Total: {{ donations.length }} donación{{ donations.length !== 1 ? 'es' : '' }}</span>
    </div>

    <!-- Tabs de filtrado -->
    <div class="card-tabs">
      <app-tab-group
        [tabs]="donationFilterTabs"
        [theme]="'donor'"
        (tabChange)="onDonationFilterChange($event)">
      </app-tab-group>
    </div>
    
    <div class="card-body">
      <!-- Mensaje de error -->
      <div *ngIf="errorMessage" class="error-message">
        <lucide-icon name="info" class="error-icon"></lucide-icon>
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Estado de carga -->
      <div *ngIf="isLoading" class="loading-state">
        <p>Cargando donaciones...</p>
      </div>

      <!-- Contador de donaciones filtradas -->
      <div *ngIf="!isLoading && !errorMessage" class="filter-counter">
        <lucide-icon name="filter" class="filter-icon"></lucide-icon>
        <span>{{ filteredCount }} donación{{ filteredCount !== 1 ? 'es' : '' }}</span>
      </div>

      <!-- Lista de donaciones -->
      <div *ngIf="!isLoading && !errorMessage" class="donations-grid">
        
        <div *ngFor="let donation of filteredDonations" class="donation-wrapper">
          <app-card-donation 
            [donation]="donation"
            [theme]="'donor'">
          </app-card-donation>

          <div class="donation-actions">
            <!-- Botón de Confirmar Entrega (Solo si está ASIGNADA y el donante NO ha confirmado) -->
            <app-button 
              *ngIf="donation.status === 'ASSIGNED' && !donation.donorConfirmed"
              (click)="onConfirmDonation(donation.id)" 
              theme="donor"
              [disabled]="isLoading"
              class="confirm-button">
              <lucide-icon [img]="icons.checkCircle" class="button-icon"></lucide-icon>
              Confirmar Entrega
            </app-button>

            <!-- Mensaje de espera (Si YA confirmó pero el beneficiario no) -->
            <div *ngIf="donation.status === 'ASSIGNED' && donation.donorConfirmed" class="waiting-status" style="display: flex; align-items: center; gap: 0.5rem; color: #f59e0b; font-weight: 500; font-size: 0.9rem;">
              <lucide-icon [img]="icons.clock" style="width: 18px; height: 18px;"></lucide-icon>
              <span>Esperando confirmación del beneficiario</span>
            </div>
          </div>
        </div>

        <!-- Mensaje cuando no hay donaciones -->
        <div *ngIf="filteredDonations.length === 0" class="empty-state">
          <p *ngIf="donationFilterTab === 'available'">No tienes donaciones disponibles.</p>
          <p *ngIf="donationFilterTab === 'pending'">No tienes donaciones pendientes de entrega.</p>
          <p *ngIf="donationFilterTab === 'delivered'">No tienes donaciones entregadas.</p>
          <p class="empty-subtitle" *ngIf="donations.length === 0">Haz clic en "Publicar Nueva Donación" para comenzar.</p>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Modal de Nueva Donación -->
<app-modal-new-donation
  *ngIf="showNewDonationModal"
  [errorMessage]="modalErrorMessage"
  [isLoading]="isLoading"
  (close)="onModalClose()"
  (submit)="onDonationSubmit($event)">
</app-modal-new-donation>
