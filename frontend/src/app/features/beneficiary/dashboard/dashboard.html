<app-toast-container></app-toast-container>

<app-header 
  title="Dashboard de Beneficiario" 
  subtitle="Comedor La Esperanza"
  theme="beneficiary"
  (logoutClick)="handleLogout()">
</app-header>

<main class="dashboard-content">
  <!-- Banner de Notificaciones -->
  <app-notification-banner 
    [notificationCount]="availableCount"
    theme="beneficiary">
  </app-notification-banner>

  <!-- Tarjeta de Donaciones -->
  <div class="card">
    <div class="card-header-with-count">
      <app-card-header 
        title="Mis Donaciones" 
        icon="package" 
        theme="beneficiary">
      </app-card-header>
      <span class="donation-count">Total: {{ allDonations.length }} donación{{ allDonations.length !== 1 ? 'es' : '' }}</span>
    </div>

    <!-- Tabs de filtrado -->
    <div class="card-tabs">
      <app-tab-group
        [tabs]="donationFilterTabs"
        [theme]="'beneficiary'"
        (tabChange)="onDonationFilterChange($event)">
      </app-tab-group>
    </div>
    
    <div class="card-body">
      <!-- Mensaje de error -->
      <div *ngIf="errorMessage" class="error-message">
        <lucide-icon [img]="icons.info" class="error-icon"></lucide-icon>
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Estado de carga -->
      <div *ngIf="isLoading" class="loading-state">
        <p>Cargando donaciones...</p>
      </div>

      <!-- Contador de donaciones filtradas -->
      <div *ngIf="!isLoading && !errorMessage" class="filter-counter">
        <lucide-icon [img]="icons.filter" class="filter-icon"></lucide-icon>
        <span>{{ filteredCount }} donación{{ filteredCount !== 1 ? 'es' : '' }}</span>
      </div>

      <!-- Lista de donaciones -->
      <div *ngIf="!isLoading && !errorMessage" class="donations-grid">
        <div *ngFor="let donation of filteredDonations" class="donation-wrapper">
          <app-card-donation 
            [donation]="donation"
            [theme]="'beneficiary'">
          </app-card-donation>
          <div class="donation-actions">
            <app-button 
              *ngIf="donation.status === 'AVAILABLE'"
              (click)="onClaimDonation(donation)" 
              theme="beneficiary"
              class="claim-button">
              ¡Reclamar Donación!
            </app-button>
            
            <!-- Botón de Confirmar (Solo si NO ha confirmado aún) -->
            <app-button 
              *ngIf="donation.status === 'ASSIGNED' && !donation.beneficiaryConfirmed"
              (click)="onConfirmDonation(donation.id)" 
              theme="beneficiary"
              [disabled]="isLoading"
              class="confirm-button">
              <lucide-icon [img]="icons.checkCircle" class="button-icon"></lucide-icon>
              Confirmar Recepción
            </app-button>

            <!-- Mensaje de espera (Si YA confirmó pero el donante no) -->
            <div *ngIf="donation.status === 'ASSIGNED' && donation.beneficiaryConfirmed" class="waiting-status" style="display: flex; align-items: center; gap: 0.5rem; color: #f59e0b; font-weight: 500; font-size: 0.9rem;">
              <lucide-icon [img]="icons.clock" style="width: 18px; height: 18px;"></lucide-icon>
              <span>Esperando confirmación del donante</span>
            </div>
          </div>
        </div>

        <!-- Mensaje cuando no hay donaciones -->
        <div *ngIf="filteredDonations.length === 0" class="empty-state">
          <p *ngIf="donationFilterTab === 'available'">No hay donaciones disponibles para reclamar.</p>
          <p *ngIf="donationFilterTab === 'pending'">No tienes donaciones pendientes de confirmar.</p>
          <p *ngIf="donationFilterTab === 'delivered'">No tienes donaciones entregadas.</p>
          <p class="empty-subtitle" *ngIf="allDonations.length === 0">Las donaciones aparecerán aquí cuando los donantes las publiquen.</p>
        </div>
      </div>
    </div>
  </div>
</main>
